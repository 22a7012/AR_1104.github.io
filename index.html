<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>Marker-less AR</title>

    <!-- ✅ Three.js と DeviceOrientationControls をCDNで読み込み -->
    <script type="module">
      import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";
      import { DeviceOrientationControls } from "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/DeviceOrientationControls.js";

      let w, h, canvas, scene, camera, renderer, object, controls;
      let deviceOrienModal = null;
      let deviceOrienModalButton = null;
      let video = null;
      let videoInput = null;
      let videoStream = null;

      const initVideo = () => {
        video = document.getElementById("camera");
        video.addEventListener("loadedmetadata", adjustVideo);

        navigator.mediaDevices
          .enumerateDevices()
          .then((devices) => {
            videoInput = devices.filter((device) => device.kind === "videoinput");
            getVideo();
          })
          .catch((error) => {
            console.log(error);
          });
      };

      const setVideo = (backCamera) => {
        return {
          audio: false,
          video: {
            deviceId: backCamera ? { exact: backCamera.deviceId } : undefined,
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          },
        };
      };

      const getVideo = () => {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
        }

        const backCamera =
          videoInput.find((d) =>
            d.label.toLowerCase().includes("back")
          ) || videoInput[0];

        navigator.mediaDevices
          .getUserMedia(setVideo(backCamera))
          .then((stream) => {
            video.srcObject = stream;
            video.play();
            videoStream = stream;
          })
          .catch((error) => {
            console.log(error);
            alert(
              "カメラの使用が拒否されています。\nページを再読み込みして使用を許可するか、ブラウザの設定をご確認ください。"
            );
          });
      };

      const adjustVideo = () => {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;

        const videoAspect = videoWidth / videoHeight;
        const windowAspect = windowWidth / windowHeight;

        if (windowAspect < videoAspect) {
          const newWidth = videoAspect * windowHeight;
          video.style.width = newWidth + "px";
          video.style.marginLeft = -(newWidth - windowWidth) / 2 + "px";
          video.style.height = windowHeight + "px";
          video.style.marginTop = "0px";
        } else {
          const newHeight = 1 / (videoAspect / windowWidth);
          video.style.height = newHeight + "px";
          video.style.marginTop = -(newHeight - windowHeight) / 2 + "px";
          video.style.width = windowWidth + "px";
          video.style.marginLeft = "0px";
        }
      };

      const isIos = () => {
        const ua = navigator.userAgent.toLowerCase();
        return (
          ua.indexOf("iphone") >= 0 ||
          ua.indexOf("ipad") >= 0 ||
          ua.indexOf("ipod") >= 0
        );
      };

      const checkDeviceOrien = () => {
        return new Promise((resolve, reject) => {
          if (!isIos()) {
            resolve("resolve");
            return;
          }

          const deviceOrienEvent = () => {
            hideDeviceOrienModal();
            window.removeEventListener("deviceorientation", deviceOrienEvent, false);
            resolve("resolve");
          };
          window.addEventListener("deviceorientation", deviceOrienEvent, false);

          deviceOrienModal = document.getElementById("device-orien-modal");
          deviceOrienModalButton = document.getElementById("device-orien-modal-button");
          const alertMessage =
            "モーションセンサーの使用が拒否されました。\nSafariを再起動して「動作と方向」へのアクセスを許可してください。";
          deviceOrienModal.classList.remove("is-hidden");

          deviceOrienModalButton.addEventListener("click", () => {
            if (
              DeviceMotionEvent &&
              DeviceMotionEvent.requestPermission &&
              typeof DeviceMotionEvent.requestPermission === "function"
            ) {
              DeviceMotionEvent.requestPermission().then(() => {});
            }

            if (
              DeviceOrientationEvent &&
              DeviceOrientationEvent.requestPermission &&
              typeof DeviceOrientationEvent.requestPermission === "function"
            ) {
              DeviceOrientationEvent.requestPermission().then((res) => {
                if (res === "granted") {
                  hideDeviceOrienModal();
                  resolve("resolve");
                } else {
                  alert(alertMessage);
                  reject("resolve");
                }
              });
            } else {
              alert(alertMessage);
              reject("resolve");
            }
          });
        });
      };

      const hideDeviceOrienModal = () => {
        deviceOrienModal.classList.add("is-hidden");
      };

      const initThree = () => {
        w = window.innerWidth;
        h = window.innerHeight;
        canvas = document.getElementById("canvas");
        setScene();
        setCamera();
        setObject();
        setRenderer();
        controls = new DeviceOrientationControls(camera);
      };

      const setScene = () => {
        scene = new THREE.Scene();
      };

      const setCamera = () => {
        camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 30);
        camera.position.set(0, 0, 5);
        camera.lookAt(0, 0, 0);
        scene.add(camera);
      };

      const setObject = () => {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshNormalMaterial();
        object = new THREE.Mesh(geometry, material);
        scene.add(object);
      };

      const setRenderer = () => {
        renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true,
          canvas: canvas,
        });
        renderer.setClearColor(0x000000, 0);
        renderer.setSize(w, h);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setAnimationLoop(() => {
          render();
        });
      };

      const render = () => {
        object.rotation.x += 0.01;
        object.rotation.y += 0.01;
        controls.update();
        renderer.render(scene, camera);
      };

      window.onload = () => {
        checkDeviceOrien()
          .then(() => {
            initThree();
            initVideo();
          })
          .catch((error) => {
            console.log(error);
          });
      };
    </script>

    <style>
      body {
        overflow: hidden;
        margin: 0;
        font-family: sans-serif;
      }
      .device-orien-modal {
        z-index: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.7);
      }
      .device-orien-modal-inner {
        width: 90%;
        max-width: 350px;
        box-sizing: border-box;
        height: auto;
        padding: 1.3rem;
        margin: auto;
        background: white;
        display: flex;
        flex-direction: column;
      }
      .device-orien-modal-button {
        margin: 1rem auto auto;
        padding: 0.8rem 1.3rem;
        background: black;
        color: white;
        width: 130px;
      }
      .is-hidden {
        display: none;
      }
      .canvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
      }
      .camera {
        position: fixed;
        top: 0;
        left: 0;
      }
    </style>
  </head>

  <body>
    <div id="device-orien-modal" class="device-orien-modal is-hidden">
      <div class="device-orien-modal-inner">
        <p>
          このページでは端末の向きと方向を取得します。<br />
          次に表示されるポップアップに従って「許可」を選択してください。
        </p>
        <button id="device-orien-modal-button" class="device-orien-modal-button">
          OK
        </button>
      </div>
    </div>
    <canvas id="canvas" class="canvas"></canvas>
    <video id="camera" class="camera" playsinline></video>
  </body>
</html>
